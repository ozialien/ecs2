---
# Use Case 9: Config Change - Ansible Playbook

- name: Update Service Configuration
  hosts: localhost
  gather_facts: false
  vars:
    project_name: "{{ project | default('myapp') }}"
    environment: "{{ env | default('dev') }}"
    aws_region: "{{ region | default('us-east-1') }}"
    cluster_name: "{{ cluster_name }}"
    service_name: "{{ service_name }}"
    new_desired_count: "{{ new_desired_count | default(omit) }}"
    new_cpu: "{{ new_cpu | default(omit) }}"
    new_memory: "{{ new_memory | default(omit) }}"
    new_env_vars: "{{ new_env_vars | default({}) }}"

  tasks:
    - name: Get Current Task Definition
      shell: |
        aws ecs describe-services \
          --cluster "{{ cluster_name }}" \
          --services "{{ service_name }}" \
          --region "{{ aws_region }}" \
          --query 'services[0].taskDefinition' \
          --output text
      register: current_task_def

    - name: Get Task Definition JSON
      shell: |
        aws ecs describe-task-definition \
          --task-definition "{{ current_task_def.stdout }}" \
          --region "{{ aws_region }}" \
          --query 'taskDefinition' \
          --output json > /tmp/task-def.json

    - name: Update Task Definition with New Config
      shell: |
        jq '.cpu = "{{ new_cpu }}" | .memory = "{{ new_memory }}"' /tmp/task-def.json > /tmp/task-def-updated.json
        jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' /tmp/task-def-updated.json > /tmp/task-def-final.json
      when: new_cpu is defined or new_memory is defined

    - name: Update Environment Variables
      shell: |
        jq '.containerDefinitions[0].environment = {{ new_env_vars | to_json }}' /tmp/task-def-final.json > /tmp/task-def-env.json
        mv /tmp/task-def-env.json /tmp/task-def-final.json
      when: new_env_vars | length > 0

    - name: Register Updated Task Definition
      shell: |
        aws ecs register-task-definition \
          --cli-input-json file:///tmp/task-def-final.json \
          --region "{{ aws_region }}"
      register: new_task_def
      when: new_cpu is defined or new_memory is defined or new_env_vars | length > 0

    - name: Update Service
      community.aws.ecs_service:
        name: "{{ service_name }}"
        cluster: "{{ cluster_name }}"
        task_definition: "{{ new_task_def.taskDefinition.taskDefinitionArn | default(omit) }}"
        desired_count: "{{ new_desired_count | default(omit) }}"
        region: "{{ aws_region }}"
      register: updated_service

    - name: Display Config Change Info
      debug:
        msg:
          - "Configuration updated"
          - "New Desired Count: {{ updated_service.service.desiredCount | default('unchanged') }}"
          - "New Task Definition: {{ new_task_def.taskDefinition.taskDefinitionArn | default('unchanged') }}"

