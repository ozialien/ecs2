---
# Use Case 7: Emergency Hotfix - Ansible Playbook

- name: Emergency Hotfix Deployment
  hosts: localhost
  gather_facts: false
  vars:
    project_name: "{{ project | default('myapp') }}"
    environment: "{{ env | default('dev') }}"
    aws_region: "{{ region | default('us-east-1') }}"
    cluster_name: "{{ cluster_name }}"
    service_name: "{{ service_name }}"
    hotfix_image_uri: "{{ hotfix_image_uri }}"
    hotfix_tag: "{{ hotfix_tag | default('hotfix-' + ansible_date_time.date) }}"
    task_definition_family: "{{ task_definition_family }}"

  tasks:
    - name: Get Current Task Definition
      shell: |
        aws ecs describe-services \
          --cluster "{{ cluster_name }}" \
          --services "{{ service_name }}" \
          --region "{{ aws_region }}" \
          --query 'services[0].taskDefinition' \
          --output text
      register: current_task_def

    - name: Get Task Definition JSON
      shell: |
        aws ecs describe-task-definition \
          --task-definition "{{ current_task_def.stdout }}" \
          --region "{{ aws_region }}" \
          --query 'taskDefinition' \
          --output json > /tmp/task-def.json
      register: task_def_json

    - name: Update Task Definition with Hotfix Image
      shell: |
        jq '.containerDefinitions[0].image = "{{ hotfix_image_uri }}:{{ hotfix_tag }}"' /tmp/task-def.json > /tmp/task-def-hotfix.json
        jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' /tmp/task-def-hotfix.json > /tmp/task-def-final.json
      when: task_def_json.rc == 0

    - name: Register Hotfix Task Definition
      shell: |
        aws ecs register-task-definition \
          --cli-input-json file:///tmp/task-def-final.json \
          --region "{{ aws_region }}"
      register: hotfix_task_def
      when: task_def_json.rc == 0

    - name: Force New Deployment with Hotfix
      community.aws.ecs_service:
        name: "{{ service_name }}"
        cluster: "{{ cluster_name }}"
        task_definition: "{{ hotfix_task_def.taskDefinition.taskDefinitionArn }}"
        force_new_deployment: true
        region: "{{ aws_region }}"
      register: hotfix_deployment
      when: hotfix_task_def is defined

    - name: Display Hotfix Info
      debug:
        msg:
          - "Emergency hotfix deployed"
          - "Hotfix Image: {{ hotfix_image_uri }}:{{ hotfix_tag }}"
          - "Task Definition: {{ hotfix_task_def.taskDefinition.taskDefinitionArn | default('N/A') }}"
          - "Deployment ID: {{ hotfix_deployment.service.deployments[0].id | default('N/A') }}"

