---
# Use Case 3: CI/CD Pipeline Setup - Ansible Playbook

- name: Setup CI/CD Pipeline
  hosts: localhost
  gather_facts: false
  vars:
    project_name: "{{ project | default('myapp') }}"
    environment: "{{ env | default('dev') }}"
    aws_region: "{{ region | default('us-east-1') }}"
    source_repository: "{{ source_repository | default('github.com/user/repo') }}"
    source_branch: "{{ source_branch | default('main') }}"
    code_star_connection_arn: "{{ code_star_connection_arn }}"
    ecr_repository_uri: "{{ ecr_repository_uri }}"
    ecs_cluster_name: "{{ ecs_cluster_name }}"
    ecs_service_name: "{{ ecs_service_name }}"

  tasks:
    - name: Create S3 Artifacts Bucket
      community.aws.s3_bucket:
        name: "{{ project_name }}-pipeline-artifacts-{{ environment }}-{{ account_id }}"
        versioning: true
        encryption: AES256
        region: "{{ aws_region }}"
        tags:
          Project: "{{ project_name }}"
          Environment: "{{ environment }}"
          ManagedBy: Ansible
      register: artifacts_bucket

    - name: Create CodeBuild Project
      community.aws.codebuild_project:
        name: "{{ project_name }}-build-{{ environment }}"
        description: "CodeBuild project for {{ project_name }} in {{ environment }}"
        service_role: "{{ project_name }}-codebuild-role-{{ environment }}"
        source:
          type: CODEPIPELINE
        artifacts:
          type: CODEPIPELINE
        environment:
          type: LINUX_CONTAINER
          image: aws/codebuild/standard:7.0
          compute_type: BUILD_GENERAL1_SMALL
          privileged_mode: true
        region: "{{ aws_region }}"
      register: codebuild_project

    - name: Create CodePipeline
      community.aws.codepipeline:
        name: "{{ project_name }}-pipeline-{{ environment }}"
        role_arn: "{{ project_name }}-codepipeline-role-{{ environment }}"
        artifact_store:
          type: S3
          location: "{{ artifacts_bucket.name }}"
        stages:
          - name: Source
            actions:
              - name: SourceAction
                action_type_id:
                  category: Source
                  owner: AWS
                  provider: CodeStarSourceConnection
                  version: '1'
                configuration:
                  ConnectionArn: "{{ code_star_connection_arn }}"
                  FullRepositoryId: "{{ source_repository }}"
                  BranchName: "{{ source_branch }}"
                output_artifacts:
                  - SourceOutput
          - name: Build
            actions:
              - name: BuildAction
                action_type_id:
                  category: Build
                  owner: AWS
                  provider: CodeBuild
                  version: '1'
                configuration:
                  ProjectName: "{{ codebuild_project.name }}"
                input_artifacts:
                  - SourceOutput
                output_artifacts:
                  - BuildOutput
          - name: Deploy
            actions:
              - name: DeployAction
                action_type_id:
                  category: Deploy
                  owner: AWS
                  provider: ECS
                  version: '1'
                configuration:
                  ClusterName: "{{ ecs_cluster_name }}"
                  ServiceName: "{{ ecs_service_name }}"
                input_artifacts:
                  - BuildOutput
        region: "{{ aws_region }}"
      register: pipeline

    - name: Display Pipeline Info
      debug:
        msg:
          - "Pipeline Name: {{ pipeline.name }}"
          - "Pipeline ARN: {{ pipeline.arn }}"
          - "Artifacts Bucket: {{ artifacts_bucket.name }}"

