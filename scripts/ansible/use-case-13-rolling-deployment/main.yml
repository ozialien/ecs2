---
# Use Case 13: Rolling Deployment - Ansible Playbook

- name: Rolling Deployment
  hosts: localhost
  gather_facts: false
  vars:
    project_name: "{{ project | default('myapp') }}"
    environment: "{{ env | default('dev') }}"
    aws_region: "{{ region | default('us-east-1') }}"
    cluster_name: "{{ cluster_name }}"
    service_name: "{{ service_name }}"
    task_definition_arn: "{{ task_definition_arn }}"
    maximum_percent: "{{ maximum_percent | default(200) }}"
    minimum_healthy_percent: "{{ minimum_healthy_percent | default(50) }}"

  tasks:
    - name: Update Service with Rolling Deployment Configuration
      community.aws.ecs_service:
        name: "{{ service_name }}"
        cluster: "{{ cluster_name }}"
        task_definition: "{{ task_definition_arn }}"
        deployment_configuration:
          maximum_percent: "{{ maximum_percent }}"
          minimum_healthy_percent: "{{ minimum_healthy_percent }}"
        deployment_circuit_breaker:
          enable: true
          rollback: true
        region: "{{ aws_region }}"
      register: updated_service

    - name: Wait for Rolling Deployment to Complete
      community.aws.ecs_service:
        name: "{{ service_name }}"
        cluster: "{{ cluster_name }}"
        region: "{{ aws_region }}"
      register: service_status
      until: service_status.service.runningCount == service_status.service.desiredCount
      retries: 30
      delay: 10

    - name: Display Deployment Info
      debug:
        msg:
          - "Rolling deployment completed"
          - "Service: {{ service_name }}"
          - "Task Definition: {{ task_definition_arn }}"
          - "Running Count: {{ service_status.service.runningCount }}"
          - "Desired Count: {{ service_status.service.desiredCount }}"

